<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>AbleSync</title>
    <style>
      body {
        font-family: sans-serif;
        background: #1e1e1e;
        color: #eee;
        margin: 0;
        padding: 0;
        overflow-y: hidden;
      }

      #container {
        display: flex;
        flex-direction: column;
        gap: 0;
        overflow-y: hidden;
        height: 100vh;
      }
      #controls {
        display: flex;
        align-items: center;
        justify-content: space-around;
        flex-wrap: wrap;
        gap: 10px;
        padding: 10px;
        background: #2c2c2c;
      }
      button {
        padding: 5px 10px;
        border-radius: 12px;
        border: none;
        cursor: pointer;
      }
      pre {
        margin: 0;
        white-space: pre-wrap;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        flex-grow: 1;
      }
      .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .disconnected {
        background-color: #f64c4c;
      }
      .almost-connected {
        background-color: rgb(242, 242, 105);
      }
      .connected {
        background-color: rgb(74, 190, 74);
      }

      .info-text {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 12px;
        color: #aaa;
        text-align: center;
        padding: 5px 10px;
        background: #2c2c2c;
        border-top: 1px solid #444;
      }

      .version-info {
        font-size: 10px;
        color: #666;
        text-align: center;
        padding: 3px;
        background: #252525;
        border-top: 1px solid #333;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="controls">
        <button onclick="start('master')">Uruchom jako master</button>
        <button onclick="start('slave')">Uruchom jako slave</button>
        <button onclick="stop()">Zatrzymaj serwer</button>
        <button onclick="saveLogs()">Zapisz logi do pliku</button>
        <button onclick="clearLogs()">Wyczyść logi</button>
      </div>
      <div class="info-text">
        UDP Multicast (224.0.1.100:8080) - Nie wymaga konfiguracji IP
        <div id="statusIndicator" class="status-indicator disconnected"></div>
      </div>
      <pre id="logOutput">Logi aplikacji pojawią się tutaj...</pre>
      <div id="versionInfo" class="version-info">Wersja: ładowanie...</div>
      <p id="update-info" style="color: orange; font-weight: bold"></p>
    </div>
    <script>
      const output = document.getElementById("logOutput");
      const statusIndicator = document.getElementById("statusIndicator");
      const versionInfo = document.getElementById("versionInfo");

      let abletonConnected = false;
      let udpConnected = false;

      window.electronAPI
        .getAppVersion()
        .then((version) => {
          versionInfo.textContent = `AbleSync v${version}`;
        })
        .catch((err) => {
          versionInfo.textContent = "Wersja: błąd";
          console.error("Błąd pobierania wersji:", err);
        });

      function updateStatusIndicator() {
        if (abletonConnected && udpConnected) {
          statusIndicator.className = "status-indicator connected";
        } else if (abletonConnected || udpConnected) {
          statusIndicator.className = "status-indicator almost-connected";
        } else {
          statusIndicator.className = "status-indicator disconnected";
        }
      }

      function start(mode) {
        if (mode === "slave") {
          output.textContent += `\n[INFO] Uruchamianie slave z UDP Multicast...\n`;
          window.electronAPI.startSlave();
        } else {
          window.electronAPI.startServer(mode);
        }
      }

      function stop() {
        window.electronAPI.stopServer();
      }

      function saveLogs() {
        window.electronAPI.saveLogs(output.textContent);
      }

      function clearLogs() {
        output.textContent = "";
      }

      window.electronAPI.onLog((msg) => {
        output.textContent += msg;

        let lines = output.textContent.split("\n");

        if (lines.length > 50) {
          lines = lines.slice(lines.length - 50);
        }

        output.textContent = lines.join("\n");

        output.scrollTop = output.scrollHeight;

        if (msg.includes("Live connected") || msg.includes("Got connection!")) {
          abletonConnected = true;
        }
        if (
          msg.includes("UDP Multicast uruchomiony") ||
          msg.includes("Nasłuchiwanie UDP Multicast") ||
          msg.includes("Połączono z masterem")
        ) {
          udpConnected = true;
        }
        if (msg.includes("Serwer zatrzymany") || msg.includes("Zamykanie")) {
          abletonConnected = false;
          udpConnected = false;
        }
        if (msg.includes("Utracono połączenie z masterem")) {
          udpConnected = false;
        }

        updateStatusIndicator();
      });

      updateStatusIndicator();
    </script>
  </body>
</html>
